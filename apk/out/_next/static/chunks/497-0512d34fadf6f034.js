"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[497],{68497:(t,s,e)=>{e.d(s,{B:()=>g});var i=e(36754),a=e(32587),n=e(8703);let r="https://groupegsi.mg/rtmggmg/api",l="https://groupegsi.mg/rtmggmg",o="",c="",h={apiKey:"",prompts:{}},d={currentUser:null,users:[],lessons:[],assignments:[],submissions:[],grades:[],announcements:[],schedules:{},messages:[],reminders:[]};class u{async initWebConfig(){if(!a.Ii.isNativePlatform())try{let t=await fetch("/apk/api/config");if(t.ok){let s=await t.json();s.API_BASE&&(r=s.API_BASE),s.MEDIA_BASE&&(l=s.MEDIA_BASE),s.ADMIN_CODE&&(o=s.ADMIN_CODE),s.PROF_PASS&&(c=s.PROF_PASS),console.log("GSIStore: Web Config Loaded",{API_BASE:r,MEDIA_BASE:l})}}catch(t){console.warn("GSIStore: Failed to fetch web config, using defaults.")}}hydrate(){try{let t=localStorage.getItem("gsi_v8_master");if(t){let s=JSON.parse(t);this.state={...d,...s}}0===this.state.users.length&&this.generateMockData()}catch(t){console.error("Hydration failed",t)}}generateMockData(){[{id:"admin-id",fullName:"Nina GSI",email:"admin@gsi.mg",password:"password",role:"admin",campus:"Antananarivo",filiere:"Directeur",niveau:"N/A"},{id:"prof-id",fullName:"Professeur GSI",email:"prof@gsi.mg",password:"password",role:"professor",campus:"Antananarivo",filiere:"Informatique",niveau:"L1"}].forEach(t=>{this.state.users.find(s=>s.id===t.id)||this.state.users.push(t)}),0===this.state.lessons.length&&(this.state.lessons=[{id:"l1",title:"Guide GSI Insight",description:"Bienvenue.",subject:"G\xe9n\xe9ral",niveau:"L1",filiere:[],campus:[],date:new Date().toISOString(),files:[]}]),this.saveImmediate()}save(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveImmediate(),500)}saveImmediate(){try{localStorage.setItem("gsi_v8_master",JSON.stringify(this.state))}catch(t){console.error("Failed to save GSIStore state",t)}}notify(t,s){this.listeners[t]&&this.listeners[t].forEach(t=>{try{t(s)}catch(t){}}),Object.keys(this.listeners).forEach(e=>{e!==t&&e.startsWith(t+"_")&&this.listeners[e].forEach(t=>{try{t(s)}catch(t){}})})}startGlobalSync(){this.syncAll().then(()=>{this.autoDownloadEssentials()}),this.syncRemoteConfig(),setInterval(()=>{this.syncAll()},3e4),setInterval(()=>{this.state.currentUser&&this.fetchChatMessages()},8e3),setInterval(()=>{this.state.currentUser&&this.fetchCollection("announcements","announcements")},2e4)}async autoDownloadEssentials(){if(!this.state.currentUser)return;let{campus:t,niveau:s}=this.state.currentUser,e=this.state.schedules["".concat(t,"_").concat(s)];if(e&&(e.fileUrl||e.url))try{await this.downloadPackFile(e.fileUrl||e.url,"Schedule_".concat(t,"_").concat(s,".pdf"),e.id)}catch(t){}}async syncAll(){await Promise.all([this.fetchCollection("users","users"),this.syncRemoteConfig(),this.fetchCollection("lessons","lessons"),this.fetchCollection("assignments","assignments"),this.fetchCollection("announcements","announcements"),this.fetchCollection("grades","grades"),this.fetchCollection("schedules","schedules"),this.fetchChatMessages()]),this.cleanOfflineFiles()}async cleanOfflineFiles(){let t=JSON.parse(localStorage.getItem("gsi_progress")||"{}"),s=JSON.parse(localStorage.getItem("gsi_downloaded")||"{}"),e=new Set(this.state.lessons.map(t=>t.id)),a=new Set(this.state.assignments.map(t=>t.id));for(let r in s)if(!e.has(r)&&!a.has(r)){var n;if(console.log("GSIStore: Cleaning up deleted content ".concat(r)),null==(n=t[r])?void 0:n.localPath)try{await i.YA.deleteFile({path:t[r].localPath,directory:i.__.Data})}catch(t){}delete s[r],delete t[r]}localStorage.setItem("gsi_downloaded",JSON.stringify(s)),localStorage.setItem("gsi_progress",JSON.stringify(t))}async fetchChatMessages(){if(!this.state.currentUser)return;let{filiere:t,niveau:s}=this.state.currentUser,e=encodeURIComponent(JSON.stringify({filiere:t,niveau:s})),i=await this.apiCall("/db/messages?q=".concat(e,'&s={"timestamp":-1}&l=60'));if(i&&Array.isArray(i)){let t=i.reverse();JSON.stringify(t)!==JSON.stringify(this.state.messages)&&(this.state.messages=t,this.notify("messages",this.state.messages))}}async apiCall(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"GET",e=arguments.length>2?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(i>3)return null;let n=t.includes("messages")?3e3:3e5;if("GET"===s&&this.apiCache[t]&&Date.now()-this.apiCache[t].ts<n)return this.apiCache[t].data;this.syncingCount++,this.notify("sync_status",!0);let l=t.startsWith("http")?t:"".concat(r).concat(t.startsWith("/")?"":"/").concat(t);try{let n;if(a.Ii.isNativePlatform()){if((n=await a.pX.request({url:l,method:s,headers:{"Content-Type":"application/json"},data:e,connectTimeout:15e3,readTimeout:15e3})).status>=300&&n.status<400){let t=n.headers.Location||n.headers.location;if(t)return this.syncingCount=Math.max(0,this.syncingCount-1),this.apiCall(t,s,e,i+1)}}else{let t=new AbortController,i=setTimeout(()=>t.abort(),15e3),a={method:s,headers:{"Content-Type":"application/json"},signal:t.signal,body:e?JSON.stringify(e):void 0},r=await fetch(l,a);clearTimeout(i),n={status:r.status,data:await r.json(),ok:r.ok}}if(this.syncingCount=Math.max(0,this.syncingCount-1),0===this.syncingCount&&this.notify("sync_status",!1),n.status>=200&&n.status<300)return"GET"===s&&(this.apiCache[t]={data:n.data,ts:Date.now()}),n.data;return null}catch(s){return this.syncingCount=Math.max(0,this.syncingCount-1),0===this.syncingCount&&this.notify("sync_status",!1),console.warn("API call to ".concat(t," failed:"),s),null}}async fetchCollection(t,s){let e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=await this.apiCall("/db/".concat(s).concat(e));if(i){let s,e=Array.isArray(i)?i:[],a=this.state[t];if(Array.isArray(a)){let t=new Set(e.map(t=>t.id));s=[...e,...a.filter(s=>!t.has(s.id))]}else s={...a},e.forEach(e=>{"schedules"===t?s["".concat(e.campus,"_").concat(e.niveau)]=e:s[e.id]=e});if(this.state[t]=s,"users"===t&&this.state.currentUser){let t=s.find(t=>t.id===this.state.currentUser.id);t&&(this.state.currentUser={...this.state.currentUser,...t},this.notify("auth",this.state.currentUser))}this.save(),this.notify(t,s),Object.keys(this.listeners).forEach(e=>{e.startsWith("".concat(t,"_"))&&this.notify(e,s)})}}async syncRemoteConfig(){try{let t=await this.apiCall("/db/system_config");if(t&&Array.isArray(t)&&t.length>0){let s=t[0];s.ADMIN_CODE&&(o=s.ADMIN_CODE),s.PROF_PASS&&(c=s.PROF_PASS),s.AI_CONFIG&&(h=s.AI_CONFIG)}}catch(t){}}getAdminCode(){return o}getProfPass(){return c}getAIConfig(){return h}async updateAIConfig(t){h=t;let s=await this.apiCall("/db/system_config");s&&Array.isArray(s)&&s.length>0?await this.apiCall("/db/system_config/".concat(s[0]._id),"PATCH",{AI_CONFIG:h}):await this.apiCall("/db/system_config","POST",{AI_CONFIG:h})}async login(t,s){let e=encodeURIComponent(JSON.stringify({email:t,password:s})),i=await this.apiCall("/db/users?q=".concat(e));if(i&&Array.isArray(i)&&i.length>0){let t=i[0];return this.setCurrentUser(t),t}let a=this.state.users.find(e=>e.email===t&&e.password===s);return a?(this.setCurrentUser(a),a):null}async register(t){let s=await this.apiCall("/db/users","POST",t);if(s){let e={...t,...s};return this.setCurrentUser(e),e}return null}logout(){this.setCurrentUser(null)}async resetPassword(t){let s=encodeURIComponent(JSON.stringify({email:t})),e=await this.apiCall("/db/users?q=".concat(s));return!!(e&&Array.isArray(e))&&!!(e.length>0)}getCurrentUser(){return this.state.currentUser}setCurrentUser(t){this.state.currentUser=t,this.save(),this.notify("auth",t)}subscribe(t){return this.subscribeAuth(t)}subscribeAuth(t){return this.listeners.auth||(this.listeners.auth=[]),this.listeners.auth.push(t),t(this.state.currentUser),()=>{var s;this.listeners.auth=null==(s=this.listeners.auth)?void 0:s.filter(s=>s!==t)}}subscribeUsers(t){return this.listeners.users||(this.listeners.users=[]),this.listeners.users.push(t),t(this.state.users),this.fetchCollection("users","users"),()=>{var s;this.listeners.users=null==(s=this.listeners.users)?void 0:s.filter(s=>s!==t)}}subscribeLessons(t,s){let e=t.niveau?"lessons_".concat(t.niveau):"lessons";this.listeners[e]||(this.listeners[e]=[]);let i=e=>{s(t.niveau?e.filter(s=>s.niveau===t.niveau):e)};return this.listeners[e].push(i),i(this.state.lessons),this.fetchCollection("lessons","lessons"),()=>{var t;this.listeners[e]=null==(t=this.listeners[e])?void 0:t.filter(t=>t!==i)}}subscribeAssignments(t,s){let e=t.niveau?"assignments_".concat(t.niveau):"assignments";this.listeners[e]||(this.listeners[e]=[]);let i=e=>{s(t.niveau?e.filter(s=>s.niveau===t.niveau):e)};return this.listeners[e].push(i),i(this.state.assignments),this.fetchCollection("assignments","assignments"),()=>{var t;this.listeners[e]=null==(t=this.listeners[e])?void 0:t.filter(t=>t!==i)}}subscribeAnnouncements(t){return this.listeners.announcements||(this.listeners.announcements=[]),this.listeners.announcements.push(t),t(this.state.announcements),this.fetchCollection("announcements","announcements"),()=>{var s;this.listeners.announcements=null==(s=this.listeners.announcements)?void 0:s.filter(s=>s!==t)}}subscribeGrades(t,s){let e="grades_".concat(t);return this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(s),s(this.state.grades.filter(s=>s.studentId===t)),this.fetchCollection("grades","grades",'?q={"studentId":"'.concat(t,'"}')),()=>{var t;this.listeners[e]=null==(t=this.listeners[e])?void 0:t.filter(t=>t!==s)}}subscribeLatestSchedule(t,s,e){let i=t&&s?"".concat(t,"_").concat(s):"all",a="schedule_".concat(i);return this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(e),"all"===i?(e(this.state.schedules),this.fetchCollection("schedules","schedules")):(e(this.state.schedules[i]||null),this.fetchCollection("schedules","schedules",'?q={"campus":"'.concat(t,'","niveau":"').concat(s,'"}'))),()=>{var t;this.listeners[a]=null==(t=this.listeners[a])?void 0:t.filter(t=>t!==e)}}subscribeMessages(t){return this.listeners.messages||(this.listeners.messages=[]),this.listeners.messages.push(t),t(this.state.messages),this.fetchChatMessages(),()=>{var s;this.listeners.messages=null==(s=this.listeners.messages)?void 0:s.filter(s=>s!==t)}}subscribeSyncStatus(t){return this.listeners.sync_status||(this.listeners.sync_status=[]),this.listeners.sync_status.push(t),t(this.syncingCount>0),()=>{var s;this.listeners.sync_status=null==(s=this.listeners.sync_status)?void 0:s.filter(s=>s!==t)}}subscribeReminders(t){return this.listeners.reminders||(this.listeners.reminders=[]),this.listeners.reminders.push(t),t(this.state.reminders),()=>{var s;this.listeners.reminders=null==(s=this.listeners.reminders)?void 0:s.filter(s=>s!==t)}}subscribeSubmissions(t,s){var e;let i=t?"submissions_".concat(t):"submissions";return this.listeners[i]||(this.listeners[i]=[]),s&&this.listeners[i].push(s),s&&s((e=this.state.submissions,t?e.filter(s=>s.assignmentId===t):e)),this.fetchCollection("submissions","submissions"),()=>{var t;s&&(this.listeners[i]=null==(t=this.listeners[i])?void 0:t.filter(t=>t!==s))}}async addUser(t){this.state.users=[t,...this.state.users.filter(s=>s.id!==t.id)],this.save(),this.notify("users",this.state.users);let s=await this.apiCall('/db/users?q={"id":"'.concat(t.id,'"}'));return s&&Array.isArray(s)&&s.length>0?await this.apiCall("/db/users/".concat(s[0]._id),"PATCH",t):await this.apiCall("/db/users","POST",t)}async addLesson(t){this.state.lessons=[t,...this.state.lessons.filter(s=>s.id!==t.id)],this.save(),this.notify("lessons",this.state.lessons),await this.apiCall("/db/lessons","POST",t)}async deleteLesson(t){let s=this.state.lessons.find(s=>s.id===t);if(this.state.lessons=this.state.lessons.filter(s=>s.id!==t),this.save(),this.notify("lessons",this.state.lessons),null==s?void 0:s._id)await this.apiCall("/db/lessons/".concat(s._id),"DELETE");else{let s=encodeURIComponent(JSON.stringify({id:t})),e=await this.apiCall("/db/lessons?q=".concat(s));e&&Array.isArray(e)&&e.length>0&&await this.apiCall("/db/lessons/".concat(e[0]._id),"DELETE")}}async addAssignment(t){this.state.assignments=[t,...this.state.assignments.filter(s=>s.id!==t.id)],this.save(),this.notify("assignments",this.state.assignments),await this.apiCall("/db/assignments","POST",t)}async deleteAssignment(t){let s=this.state.assignments.find(s=>s.id===t);if(this.state.assignments=this.state.assignments.filter(s=>s.id!==t),this.save(),this.notify("assignments",this.state.assignments),null==s?void 0:s._id)await this.apiCall("/db/assignments/".concat(s._id),"DELETE");else{let s=encodeURIComponent(JSON.stringify({id:t})),e=await this.apiCall("/db/assignments?q=".concat(s));e&&Array.isArray(e)&&e.length>0&&await this.apiCall("/db/assignments/".concat(e[0]._id),"DELETE")}}async addAnnouncement(t){this.state.announcements=[t,...this.state.announcements],this.save(),this.notify("announcements",this.state.announcements),await this.apiCall("/db/announcements","POST",t)}async deleteAnnouncement(t){let s=this.state.announcements.find(s=>s.id===t);if(this.state.announcements=this.state.announcements.filter(s=>s.id!==t),this.save(),this.notify("announcements",this.state.announcements),null==s?void 0:s._id)await this.apiCall("/db/announcements/".concat(s._id),"DELETE");else{let s=encodeURIComponent(JSON.stringify({id:t})),e=await this.apiCall("/db/announcements?q=".concat(s));e&&Array.isArray(e)&&e.length>0&&await this.apiCall("/db/announcements/".concat(e[0]._id),"DELETE")}}async addGrade(t){this.state.grades=[t,...this.state.grades],this.save(),this.notify("grades",this.state.grades),await this.apiCall("/db/grades","POST",t)}async deleteGrade(t){let s=this.state.grades.find(s=>s.id===t);if(this.state.grades=this.state.grades.filter(s=>s.id!==t),this.save(),this.notify("grades",this.state.grades),null==s?void 0:s._id)await this.apiCall("/db/grades/".concat(s._id),"DELETE");else{let s=encodeURIComponent(JSON.stringify({id:t})),e=await this.apiCall("/db/grades?q=".concat(s));e&&Array.isArray(e)&&e.length>0&&await this.apiCall("/db/grades/".concat(e[0]._id),"DELETE")}}async updateUser(t){this.state.users=this.state.users.map(s=>s.id===t.id?t:s),this.state.currentUser&&this.state.currentUser.id===t.id&&(this.state.currentUser={...this.state.currentUser,...t}),this.save(),this.notify("users",this.state.users),this.notify("auth",this.state.currentUser);let s=t._id;if(s)await this.apiCall("/db/users/".concat(s),"PATCH",t);else{let s=encodeURIComponent(JSON.stringify({id:t.id})),e=await this.apiCall("/db/users?q=".concat(s));e&&Array.isArray(e)&&e.length>0&&await this.apiCall("/db/users/".concat(e[0]._id),"PATCH",t)}}async deleteUser(t){let s=this.state.users.find(s=>s.id===t);if(this.state.users=this.state.users.filter(s=>s.id!==t),this.save(),this.notify("users",this.state.users),null==s?void 0:s._id)await this.apiCall("/db/users/".concat(s._id),"DELETE");else{let s=encodeURIComponent(JSON.stringify({id:t})),e=await this.apiCall("/db/users?q=".concat(s));e&&Array.isArray(e)&&e.length>0&&await this.apiCall("/db/users/".concat(e[0]._id),"DELETE")}}async addSubmission(t){this.state.submissions=[t,...this.state.submissions.filter(s=>s.id!==t.id)],this.save(),this.notify("submissions",this.state.submissions),await this.apiCall("/db/submissions","POST",t)}async updateSubmission(t){this.state.submissions=this.state.submissions.map(s=>s.id===t.id?t:s),this.save(),this.notify("submissions",this.state.submissions);let s=await this.apiCall('/db/submissions?q={"id":"'.concat(t.id,'"}'));s&&Array.isArray(s)&&s.length>0&&await this.apiCall("/db/submissions/".concat(s[0]._id),"PATCH",t)}async addSchedule(t){let s=encodeURIComponent(JSON.stringify({campus:t.campus,niveau:t.niveau})),e=await this.apiCall("/db/schedules?q=".concat(s));e&&Array.isArray(e)&&e.length>0?await this.apiCall("/db/schedules/".concat(e[0]._id),"PATCH",t):await this.apiCall("/db/schedules","POST",t),this.state.schedules["".concat(t.campus,"_").concat(t.niveau)]=t,this.save(),this.notify("schedules",this.state.schedules)}async deleteSchedule(t){await this.apiCall("/db/schedules/".concat(t),"DELETE"),this.fetchCollection("schedules","schedules")}async sendMessage(t,s){if(!this.state.currentUser)return;let e={id:Math.random().toString(36).substr(2,9),senderId:this.state.currentUser.id,senderName:this.state.currentUser.fullName,senderPhoto:this.state.currentUser.photo,text:t,replyTo:s,timestamp:new Date().toISOString(),filiere:this.state.currentUser.filiere,niveau:this.state.currentUser.niveau};this.state.messages=[...this.state.messages,e],this.notify("messages",this.state.messages),await this.apiCall("/db/messages","POST",e)}async addReminder(t){this.state.reminders=[...this.state.reminders,t],this.save(),this.notify("reminders",this.state.reminders),this.scheduleNotification(t)}async updateReminder(t){this.state.reminders=this.state.reminders.map(s=>s.id===t.id?t:s),this.save(),this.notify("reminders",this.state.reminders),t.completed?this.cancelNotification(t.id):this.scheduleNotification(t)}async deleteReminder(t){this.state.reminders=this.state.reminders.filter(s=>s.id!==t),this.save(),this.notify("reminders",this.state.reminders),this.cancelNotification(t)}async scheduleNotification(t){if(a.Ii.isNativePlatform()){let s=new Date("".concat(t.date,"T").concat(t.time));s>new Date&&await n.LocalNotifications.schedule({notifications:[{id:parseInt(t.id.replace(/\D/g,"").substr(0,9))||Math.floor(1e6*Math.random()),title:t.isAlarm?"ALERTE PROGRAMME : ".concat(t.subject):"Rappel GSI : ".concat(t.subject),body:t.title,schedule:{at:s},sound:t.isAlarm?"alarm.wav":"default",extra:{reminderId:t.id}}]})}}async cancelNotification(t){if(a.Ii.isNativePlatform()){let s=parseInt(t.replace(/\D/g,"").substr(0,9));s&&await n.LocalNotifications.cancel({notifications:[{id:s}]})}}getAbsoluteUrl(t){if(!t||"undefined"===t||"null"===t)return"";if(t.startsWith("http://")||t.startsWith("https://")||t.startsWith("data:")||t.startsWith("blob:")||t.includes(" ")&&!t.startsWith("/")&&!t.startsWith("files/"))return t;if(t.startsWith("files/view/")||t.startsWith("api/files/view/")||t.startsWith("/api/files/view/")){let s=t.replace("api/","").replace("/api/","");return"".concat(l).concat(s.startsWith("/")?"":"/").concat(s)}let s=l;return"".concat(s).concat(t.startsWith("/")?"":"/").concat(t)}getMediaUrl(t){let s=this.getAbsoluteUrl(t);return!s||a.Ii.isNativePlatform()||s.startsWith("blob:")||s.startsWith("data:")||s.includes("groupegsi.mg")?s:"/apk/api/proxy?url=".concat(encodeURIComponent(s))}getStudentQrData(t){return JSON.stringify({m:t.matricule||"GSI-TEMP",n:t.fullName,c:t.campus,f:t.filiere,l:t.niveau,v:"https://groupegsi.mg/presence?id=".concat(t.id)})}async uploadFile(t,s,e){return new Promise((i,a)=>{let n=new XMLHttpRequest,l=new FormData;l.append("file",t,t.name),l.append("path",s),n.upload.addEventListener("progress",t=>{t.lengthComputable&&e&&e(t.loaded/t.total*100)}),n.addEventListener("load",()=>{if(n.status>=200&&n.status<300)try{let t=JSON.parse(n.responseText),s=t.viewUrl||t.downloadUrl||t.url||t.path||t.data&&t.data.url;s?i(s):a(Error("Upload succeeded but no URL returned in response"))}catch(t){a(Error("Failed to parse upload response: "+n.responseText))}else a(Error("Upload failed with status ".concat(n.status,": ").concat(n.responseText)))}),n.addEventListener("error",()=>a(Error("Network error during upload"))),n.open("POST","".concat(r,"/upload")),n.send(l)})}async downloadPackFile(t,s,e){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(n>3)throw Error("Trop de redirections.");try{let r=this.getAbsoluteUrl(t),l=s.replace(/[^a-z0-9.]/gi,"_").toLowerCase(),o="gsi_packs/".concat(e,"_").concat(l);try{return await i.YA.stat({path:o,directory:i.__.Data}),o}catch(t){}if(!window.navigator.onLine)throw Error("Connexion requise pour le t\xe9l\xe9chargement.");let c="",h="";if(a.Ii.isNativePlatform()){let t=await a.pX.get({url:r,responseType:"blob"});if(t.status>=300&&t.status<400){let i=t.headers.Location||t.headers.location;if(i)return this.downloadPackFile(i,s,e,n+1)}if(200!==t.status)throw Error("Erreur serveur (".concat(t.status,")"));c=t.data,h=t.headers["Content-Type"]||t.headers["content-type"]||""}else{let t=await fetch(r);if(!t.ok)throw Error("Erreur serveur (".concat(t.status,")"));h=t.headers.get("content-type")||"";let s=await t.blob();c=await new Promise((t,e)=>{let i=new FileReader;i.onloadend=()=>{let s=i.result.split(",")[1];s?t(s):e(Error("\xc9chec Base64"))},i.readAsDataURL(s)})}return await i.YA.writeFile({path:o,data:c,directory:i.__.Data,recursive:!0}),this.setDownloaded(e,!0),this.saveProgress(e,{localPath:o,mimeType:h}),o}catch(t){throw console.error("Pack download failed:",t),t}}async openPackFile(t,s){let e=(s||"").toLowerCase(),n="pdf";e.endsWith(".pdf")||e.includes("/pdf")?n="pdf":e.endsWith(".docx")||e.includes("word")?n="docx":e.match(/\.(mp4|mov|webm|avi|mkv|3gp|flv|wmv)$/)?n="video":e.match(/\.(jpg|jpeg|png|gif|webp|svg)$/)||e.includes("photo")?n="image":s.startsWith("http")||s.startsWith("/")||s.startsWith("files/")||(n="text");let r="text"===n?s:this.getMediaUrl(s),l=this.getProgress(t),o=((null==l?void 0:l.mimeType)||"").toLowerCase();o.includes("pdf")?n="pdf":o.includes("word")||o.includes("docx")?n="docx":o.includes("video")?n="video":o.includes("image")&&(n="image");let c=s=>{window.dispatchEvent(new CustomEvent("gsi-open-viewer",{detail:{id:t,url:s,type:n,originalUrl:r}}))};if("text"===n)return void c(s);try{if(null==l?void 0:l.localPath)try{let t=l.localPath,s=await i.YA.stat({path:t,directory:i.__.Data});if(console.log("GSIStore: Found local file at ".concat(t,", size: ").concat(s.size)),"video"===n||"image"===n){let s=await i.YA.getUri({path:t,directory:i.__.Data});c(a.Ii.convertFileSrc(s.uri));return}let e=await i.YA.readFile({path:t,directory:i.__.Data}),r="string"==typeof e.data?e.data:"",h=l.mimeType||o;h||(h="pdf"===n?"application/pdf":"docx"===n?"application/vnd.openxmlformats-officedocument.wordprocessingml.document":"video"===n?"video/mp4":"image/jpeg");let d=this.b64toBlob(r,h),u=URL.createObjectURL(d);console.log("GSIStore: Dispatched Blob URL for ".concat(n)),c(u);return}catch(s){console.warn("GSIStore: Local file check failed, re-downloading...",s),this.setDownloaded(t,!1)}if(window.navigator.onLine){let e=r.split("/").pop()||("pdf"===n?"doc.pdf":"docx"===n?"doc.docx":"video.mp4");return await this.downloadPackFile(r,e,t),this.openPackFile(t,s)}c(r)}catch(t){console.error("Open pack failed:",t),c(r)}}b64toBlob(t){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,i=atob(t),a=[];for(let t=0;t<i.length;t+=e){let s=i.slice(t,t+e),n=Array(s.length);for(let t=0;t<s.length;t++)n[t]=s.charCodeAt(t);let r=new Uint8Array(n);a.push(r)}return new Blob(a,{type:s})}async getUser(t){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],e=this.state.users.find(s=>s.id===t);if(e&&!s)return e;try{let s=encodeURIComponent(JSON.stringify({id:t})),e=await this.apiCall("/db/users?q=".concat(s));if(e&&e.length>0){let s=e[0];return this.state.users=[s,...this.state.users.filter(s=>s.id!==t)],this.save(),s}}catch(t){console.error("Error fetching user from Custom API:",t)}return e||null}async getUsers(){return this.state.users}async getLessons(){return this.state.lessons}async getAssignments(){return this.state.assignments}async getGrades(){return this.state.grades}async getAnnouncements(){return this.state.announcements}getCache(t){return this.state[t]||null}setCache(t,s){this.state[t]=s,this.save()}saveProgress(t,s){let e=JSON.parse(localStorage.getItem("gsi_progress")||"{}");e[t]={...e[t]||{},...s,ts:Date.now()},localStorage.setItem("gsi_progress",JSON.stringify(e)),this.notify("progress",e),window.dispatchEvent(new CustomEvent("gsi_progress_updated",{detail:e}))}toggleLessonCompleted(t){let s=this.getProgress(t)||{};this.saveProgress(t,{completed:!s.completed})}getProgress(t){return JSON.parse(localStorage.getItem("gsi_progress")||"{}")[t]||null}setDownloaded(t){let s=!(arguments.length>1)||void 0===arguments[1]||arguments[1],e=JSON.parse(localStorage.getItem("gsi_downloaded")||"{}");e[t]=s,localStorage.setItem("gsi_downloaded",JSON.stringify(e))}isDownloaded(t){return!!JSON.parse(localStorage.getItem("gsi_downloaded")||"{}")[t]}constructor(){this.state={...d},this.listeners={},this.saveTimeout=null,this.syncingCount=0,this.apiCache={},this.hydrate(),this.initWebConfig(),setTimeout(()=>this.startGlobalSync(),2e3),window.addEventListener("beforeunload",()=>this.saveImmediate())}}let g=new u}}]);